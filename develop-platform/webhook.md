# WebHook 说明

平台会通过用户设置的各类 WebHooks 在相应场景下有新数据时，向用户进行推送，使用户在最快时间获取到相应信息

## 1. 规则说明

- 推送的数据位于 HTTP 请求的 Body 中，均为 Json 结构，头部类型为 "Content-Type: application/json"；
- HTTP 请求发出后，请在 3 秒内进行回应，否则平台认为请求超时，进入延迟推送状态；
- HTTP 请求返回码为 200 时，表示数据推送成功，返回其他状态码，平台判断为推送失败，进入延迟推送状态；
- 延迟推送会分别在 5、15、30 分钟后尝试重新发起 HTTP 请求进行数据推送，如果期间有成功推送或 3 次均失败，都会终止该次数据后续推送，即丢弃该任务（如果仍然希望获取该丢失数据，可使用开放接口进行获取）

## 2. 签名验证

为了确保请求的安全性，平台对推送的数据进行了签名，放在请求的 Json 结构体中，签名使用的参数包括：

| 参数      | 类型   | 描述                        |
| --------- | ------ | --------------------------- |
| timestamp | int    | Unix 时间戳                 |
| token     | string | 随机字符串                  |
| signature | string | HMAC 编码后的十六进制字符串 |

验证签名方式：

- 拼接 timestamp 和 token，中间无分隔符；
- 使用 HMAC 对拼接后的字符串进行编码（使用您在平台的 API Secret 和 SHA256 签名）；
- 将得到的签名结果与请求体中的 signature 进行对比，以验证请求合法性；
- 建议：可以缓存 token 字段，以避免重放攻击；
- 建议：可以检查 timestamp 字段，以避免过期请求
- 说明：鉴于推送的数据格式多样，内容可能较大，所以选择对部分字段进行签名

## 3. WebHook 支持列表

## 3.1 设备数据推送

当设备有新数据时，平台通过此回调地址，将设备数据推送给开发者云服务。

### 3.1.1 数据结构说明

| 参数名称          | 类型   | 出现要求 | 描述                   |
| ----------------- | ------ | -------- | ---------------------- |
| info.mac          | string | R        | 设备 MAC 地址          |
| info.product.id   | int    | R        | 设备所属产品类型ID     |
| info.product.desc | string | R        | 设备所属产品类型描述   |
| info.name         | string | R        | 设备名称（用户定义的） |
| data              | list   | R        | 设备数据（数组）       |

设备数据字段说明
不同设备支持的传感器种类不同，所以该结构里的字段均为可选字段

| 参数名称    | 类型   | 出现要求 | 描述           |
| ----------- | ------ | -------- | -------------- |
| temperature | struct | O        | 温度（结构体） |
| humidity    | struct | O        | 湿度           |
| pressure    | struct | O        | 气压           |
| battery     | struct | O        | 电量           |
| timestamp   | struct | O        | Unix 时间戳    |

设备数据子类描述
不同传感器种类输出的数据格式不同，所以该结构里的字段均为可选字段

| 参数名称 | 类型   | 出现要求 | 描述 |
| -------- | ------ | -------- | ---- |
| value    | float  | O        | 数字 |
| level    | string | O        | 等级 |

### 3.1.1 数据样例

```json
{

}
```

## 3.2 设备事件推送

当设备有新数据时，平台通过此回调地址，将设备数据推送给开发者云服务。

### 3.2.1 事件结构说明

| 参数名称          | 类型   | 出现要求 | 描述                   |
| ----------------- | ------ | -------- | ---------------------- |
| info.mac          | string | R        | 设备 MAC 地址          |
| info.product.id   | int    | R        | 设备所属产品类型ID     |
| info.product.desc | string | R        | 设备所属产品类型描述   |
| info.name         | string | R        | 设备名称（用户定义的） |
| events            | list   | R        | 设备事件（数组）       |

设备事件字段说明

| 参数名称     | 类型   | 出现要求 | 描述               |
| ------------ | ------ | -------- | ------------------ |
| data         | struct | O        | 触发事件的设备数据 |
| alert_config | struct | O        | 触发的事件         |
| status       | int    | O        | 事件发生或解除     |

设备数据字段说明
不同设备支持的传感器种类不同，所以该结构里的字段均为可选字段

| 参数名称    | 类型   | 出现要求 | 描述           |
| ----------- | ------ | -------- | -------------- |
| temperature | struct | O        | 温度（结构体） |
| humidity    | struct | O        | 湿度           |
| pressure    | struct | O        | 气压           |
| battery     | struct | O        | 电量           |
| timestamp   | struct | O        | Unix 时间戳    |

设备数据子类描述
不同传感器种类输出的数据格式不同，所以该结构里的字段均为可选字段

| 参数名称 | 类型   | 出现要求 | 描述 |
| -------- | ------ | -------- | ---- |
| value    | float  | O        | 数字 |
| level    | string | O        | 等级 |

设备事件字段描述

| 参数名称    | 类型   | 出现要求 | 描述                           |
| ----------- | ------ | -------- | ------------------------------ |
| metric_name | string | R        | 事件属性（温度、湿度、电量等） |
| operator    | string | R        | 触发条件（大于/小于）          |
| threshold   | int    | R        | 事件阈值                       |

### 3.2.2 数据样例

```json
{

}
```
